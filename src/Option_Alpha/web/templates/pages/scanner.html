{% extends "base.html" %}

{% block title %}Scanner â€” Option Alpha{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-zinc-100">Scanner</h1>
    <button id="run-scan-btn"
            hx-post="/scanner/run"
            hx-ext="sse"
            sse-connect="/scanner/run"
            sse-swap="progress"
            hx-target="#scan-progress-area"
            hx-swap="innerHTML"
            onclick="this.disabled=true; this.classList.add('opacity-50');
                     document.getElementById('scan-progress-area').classList.remove('hidden');
                     const src = new EventSource('/scanner/run', {withCredentials: false});
                     const btn = this;
                     src.addEventListener('progress', function(e) {
                       document.getElementById('scan-progress-area').innerHTML = e.data;
                     });
                     src.addEventListener('complete', function(e) {
                       document.getElementById('scan-results-container').innerHTML = e.data;
                       document.getElementById('scan-progress-area').classList.add('hidden');
                       btn.disabled = false;
                       btn.classList.remove('opacity-50');
                       src.close();
                     });
                     src.addEventListener('error', function(e) {
                       document.getElementById('scan-progress-area').innerHTML =
                         '<p class=&quot;text-red-400&quot;>Scan failed or connection lost.</p>';
                       btn.disabled = false;
                       btn.classList.remove('opacity-50');
                       src.close();
                     });
                     return false;"
            class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm
                   font-medium rounded-lg transition-colors">
      Run Scan
    </button>
  </div>

  <!-- Progress Area (hidden by default) -->
  <div id="scan-progress-area" class="hidden"></div>

  <!-- Results Table -->
  <div id="scan-results-container">
    {% if scores %}
    {% include "partials/scan_table.html" %}
    {% else %}
    <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-8 text-center">
      <p class="text-zinc-400">No scan results yet. Click "Run Scan" to start.</p>
    </div>
    {% endif %}
  </div>

  <!-- Scan History -->
  {% if scans %}
  <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-6">
    <h2 class="text-lg font-semibold text-zinc-200 mb-4">Scan History</h2>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-zinc-500 border-b border-zinc-800">
          <th class="text-left py-2 font-medium" scope="col">Date</th>
          <th class="text-left py-2 font-medium" scope="col">Preset</th>
          <th class="text-right py-2 font-medium" scope="col">Tickers</th>
          <th class="text-left py-2 font-medium" scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for scan in scans %}
        <tr class="border-b border-zinc-800/50 hover:bg-zinc-800/50 transition-colors cursor-pointer"
            hx-get="/scanner/results?scan_id={{ scan.id }}"
            hx-target="#scan-results-container"
            hx-swap="innerHTML">
          <td class="py-2 text-zinc-300">{{ scan.started_at|timeago }}</td>
          <td class="py-2 text-zinc-400">{{ scan.preset }}</td>
          <td class="py-2 text-right text-zinc-300">{{ scan.ticker_count }}</td>
          <td class="py-2">
            <span class="text-xs px-2 py-0.5 rounded-full
              {% if scan.status == 'completed' %}bg-emerald-900/50 text-emerald-400
              {% elif scan.status == 'running' %}bg-amber-900/50 text-amber-400
              {% else %}bg-red-900/50 text-red-400{% endif %}">
              {{ scan.status }}
            </span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}
